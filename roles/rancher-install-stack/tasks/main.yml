---
- include_vars: "{{ inventory_dir }}/group_vars/{{ NAME_PROJECT }}/apikey.yml"

- debug: msg="Installing stack {{ STACK_NAME }}"

- name: create stacks folder
  file: path=stacks/{{STACK_NAME}} state=directory mode=0700

- name: copy docker-compose for stack
  template: src={{STACK_NAME}}/docker-compose.yml dest=stacks/{{STACK_NAME}}/docker-compose.yml

- name: copy rancher-compose for stack
  template: src={{STACK_NAME}}/rancher-compose.yml dest=stacks/{{STACK_NAME}}/rancher-compose.yml

- name: run rancher-compose upgrade
  command: "rancher --debug --url {{rancher_master_url}} --access-key {{RANCHER_API_PROJECT_ACCESS_TOKEN}} --secret-key {{RANCHER_API_PROJECT_ACCESS_SECRET}} up -s {{STACK_NAME | quote}} -d {{rancher_compose_opts}}"
  args:
    chdir: "stacks/{{STACK_NAME}}"
  register: stack_upgrade
  become: yes

- debug: var=stack_upgrade

- name: run rancher-compose confirm upgrade
  command: "rancher --debug --url {{rancher_master_url}} --access-key {{RANCHER_API_PROJECT_ACCESS_TOKEN}} --secret-key {{RANCHER_API_PROJECT_ACCESS_SECRET}} up -s {{STACK_NAME | quote}} -d  --confirm-upgrade"
  args:
    chdir: "stacks/{{STACK_NAME}}"
  register: stack_confirm_upgrade
  become: yes

- debug: var=stack_confirm_upgrade
